{"code":"import { ScreepsAPI } from 'screeps-api';\r\nimport * as fs from 'fs';\r\nimport * as git from 'git-rev-sync';\r\nimport * as path from 'path';\r\nexport function generateSourceMaps(bundle) {\r\n    var b = bundle;\r\n    var tmp = b.map.toString;\r\n    delete b.map.sourceContent;\r\n    b.map.toString = function () {\r\n        return \"module.exports = \" + tmp.apply(this, arguments) + \";\";\r\n    };\r\n}\r\nexport function writeSourceMaps(options) {\r\n    fs.renameSync(options.file + '.map', options.file + '.map.js');\r\n}\r\nexport function validateConfig(cfg) {\r\n    return [\r\n        typeof cfg.email === \"string\",\r\n        typeof cfg.password === \"string\",\r\n        cfg.protocol === \"http\" || cfg.protocol === \"https\",\r\n        typeof cfg.hostname === \"string\",\r\n        typeof cfg.port === \"number\",\r\n        typeof cfg.path === \"string\",\r\n        typeof cfg.branch === \"string\"\r\n    ].reduce(function (a, b) { return a && b; });\r\n}\r\nexport function loadConfigFile(configFile) {\r\n    var data = fs.readFileSync(configFile, 'utf8');\r\n    var cfg = JSON.parse(data);\r\n    if (!validateConfig(cfg))\r\n        throw new TypeError(\"Invalid config\");\r\n    return cfg;\r\n}\r\nexport function uploadSource(config, options, bundle) {\r\n    if (!config) {\r\n        console.log('screeps() needs a config e.g. screeps({configFile: \\'./screeps.json\\'}) or screeps({config: { ... }})');\r\n    }\r\n    else {\r\n        if (typeof config === \"string\")\r\n            config = loadConfigFile(config);\r\n        var code_1 = getFileList(options.file);\r\n        var branch_1 = getBranchName(config.branch);\r\n        var api_1 = new ScreepsAPI();\r\n        api_1.setServer(config);\r\n        api_1.auth().then(function () {\r\n            api_1.raw.user.branches().then(function (data) {\r\n                var branches = data.list.map(function (b) { return b.branch; });\r\n                if (branches.includes(branch_1)) {\r\n                    api_1.code.set(branch_1, code_1);\r\n                }\r\n                else {\r\n                    api_1.raw.user.cloneBranch('', branch_1, code_1);\r\n                }\r\n            });\r\n        });\r\n    }\r\n}\r\nexport function getFileList(outputFile) {\r\n    var code = {};\r\n    var base = path.dirname(outputFile);\r\n    var files = fs.readdirSync(base).filter(function (f) { return path.extname(f) === '.js'; });\r\n    files.map(function (file) {\r\n        code[file.replace(/\\.js$/i, '')] = fs.readFileSync(path.join(base, file), 'utf8');\r\n    });\r\n    return code;\r\n}\r\nexport function getBranchName(branch) {\r\n    if (branch === 'auto') {\r\n        return git.branch();\r\n    }\r\n    else {\r\n        return branch;\r\n    }\r\n}\r\nexport function screeps(screepsOptions) {\r\n    if (screepsOptions === void 0) { screepsOptions = {}; }\r\n    return {\r\n        name: \"screeps\",\r\n        ongenerate: function (options, bundle) {\r\n            if (options.sourcemap)\r\n                generateSourceMaps(bundle);\r\n        },\r\n        onwrite: function (options, bundle) {\r\n            if (options.sourcemap)\r\n                writeSourceMaps(options);\r\n            if (!screepsOptions.dryRun) {\r\n                uploadSource((screepsOptions.configFile || screepsOptions.config), options, bundle);\r\n            }\r\n        }\r\n    };\r\n}\r\nexport default screeps;\r\n//# sourceMappingURL=rollup-plugin-screeps.js.map","map":{"version":3,"file":"rollup-plugin-screeps.js","sourceRoot":"","sources":["rollup-plugin-screeps.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,UAAU,EAAE,MAAM,aAAa,CAAA;AACxC,OAAO,KAAK,EAAE,MAAM,IAAI,CAAA;AACxB,OAAO,KAAK,GAAG,MAAM,cAAc,CAAA;AACnC,OAAO,KAAK,IAAI,MAAM,MAAM,CAAA;AAwB5B,MAAM,6BAA6B,MAAc;IAC/C,IAAM,CAAC,GAAG,MAAmD,CAAC;IAE9D,IAAI,GAAG,GAAG,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAA;IAExB,OAAO,CAAC,CAAC,GAAG,CAAC,aAAa,CAAA;IAE1B,CAAC,CAAC,GAAG,CAAC,QAAQ,GAAG;QACf,MAAM,CAAC,mBAAmB,GAAG,GAAG,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,GAAG,GAAG,CAAC;IAChE,CAAC,CAAA;AACH,CAAC;AAED,MAAM,0BAA0B,OAAqB;IACnD,EAAE,CAAC,UAAU,CACX,OAAO,CAAC,IAAI,GAAG,MAAM,EACrB,OAAO,CAAC,IAAI,GAAG,SAAS,CACzB,CAAA;AACH,CAAC;AAED,MAAM,yBAAyB,GAA2B;IACxD,MAAM,CAAC;QACL,OAAO,GAAG,CAAC,KAAK,KAAK,QAAQ;QAC7B,OAAO,GAAG,CAAC,QAAQ,KAAK,QAAQ;QAChC,GAAG,CAAC,QAAQ,KAAK,MAAM,IAAI,GAAG,CAAC,QAAQ,KAAK,OAAO;QACnD,OAAO,GAAG,CAAC,QAAQ,KAAK,QAAQ;QAChC,OAAO,GAAG,CAAC,IAAI,KAAK,QAAQ;QAC5B,OAAO,GAAG,CAAC,IAAI,KAAK,QAAQ;QAC5B,OAAO,GAAG,CAAC,MAAM,KAAK,QAAQ;KAC/B,CAAC,MAAM,CAAC,UAAC,CAAC,EAAC,CAAC,IAAK,OAAA,CAAC,IAAI,CAAC,EAAN,CAAM,CAAC,CAAA;AAC3B,CAAC;AAED,MAAM,yBAAyB,UAAkB;IAC/C,IAAI,IAAI,GAAG,EAAE,CAAC,YAAY,CAAC,UAAU,EAAE,MAAM,CAAC,CAAA;IAC9C,IAAI,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAA2B,CAAA;IACpD,EAAE,CAAC,CAAC,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC;QAAC,MAAM,IAAI,SAAS,CAAC,gBAAgB,CAAC,CAAA;IAC/D,MAAM,CAAC,GAAG,CAAC;AACb,CAAC;AAED,MAAM,uBAAuB,MAA8B,EAAE,OAAqB,EAAE,MAAc;IAChG,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;QACZ,OAAO,CAAC,GAAG,CAAC,uGAAuG,CAAC,CAAA;IACtH,CAAC;IAAC,IAAI,CAAC,CAAC;QACN,EAAE,CAAC,CAAC,OAAO,MAAM,KAAK,QAAQ,CAAC;YAAC,MAAM,GAAG,cAAc,CAAC,MAAM,CAAC,CAAA;QAE/D,IAAI,MAAI,GAAG,WAAW,CAAC,OAAO,CAAC,IAAI,CAAC,CAAA;QACpC,IAAI,QAAM,GAAG,aAAa,CAAC,MAAM,CAAC,MAAM,CAAC,CAAA;QAEzC,IAAI,KAAG,GAAG,IAAI,UAAU,EAAE,CAAA;QAE1B,KAAG,CAAC,SAAS,CAAC,MAAM,CAAC,CAAA;QACrB,KAAG,CAAC,IAAI,EAAE,CAAC,IAAI,CAAC;YACd,KAAG,CAAC,GAAG,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,IAAI,CAAC,UAAC,IAAS;gBACrC,IAAI,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,UAAC,CAAM,IAAK,OAAA,CAAC,CAAC,MAAM,EAAR,CAAQ,CAAC,CAAA;gBAElD,EAAE,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,QAAM,CAAC,CAAC,CAAC,CAAC;oBAC9B,KAAG,CAAC,IAAI,CAAC,GAAG,CAAC,QAAM,EAAE,MAAI,CAAC,CAAA;gBAC5B,CAAC;gBAAC,IAAI,CAAC,CAAC;oBACN,KAAG,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,EAAE,EAAE,QAAM,EAAE,MAAI,CAAC,CAAA;gBAC5C,CAAC;YACH,CAAC,CAAC,CAAA;QACJ,CAAC,CAAC,CAAA;IACJ,CAAC;AACH,CAAC;AAED,MAAM,sBAAsB,UAAkB;IAC5C,IAAI,IAAI,GAAa,EAAE,CAAA;IACvB,IAAI,IAAI,GAAG,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,CAAA;IACnC,IAAI,KAAK,GAAG,EAAE,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,UAAC,CAAC,IAAK,OAAA,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,KAAK,EAAzB,CAAyB,CAAC,CAAA;IACzE,KAAK,CAAC,GAAG,CAAC,UAAC,IAAI;QACb,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,EAAE,MAAM,CAAC,CAAA;IACnF,CAAC,CAAC,CAAA;IACF,MAAM,CAAC,IAAI,CAAA;AACb,CAAC;AAED,MAAM,wBAAwB,MAAc;IAC1C,EAAE,CAAC,CAAC,MAAM,KAAK,MAAM,CAAC,CAAC,CAAC;QACtB,MAAM,CAAC,GAAG,CAAC,MAAM,EAAE,CAAA;IACrB,CAAC;IAAC,IAAI,CAAC,CAAC;QACN,MAAM,CAAC,MAAM,CAAA;IACf,CAAC;AACH,CAAC;AAED,MAAM,kBAAkB,cAAmC;IAAnC,+BAAA,EAAA,mBAAmC;IACzD,MAAM,CAAC;QACL,IAAI,EAAE,SAAS;QAEf,UAAU,YAAC,OAAwB,EAAE,MAAc;YACjD,EAAE,CAAC,CAAC,OAAO,CAAC,SAAS,CAAC;gBAAC,kBAAkB,CAAC,MAAM,CAAC,CAAC;QACpD,CAAC;QAED,OAAO,YAAC,OAAqB,EAAE,MAAc;YAC3C,EAAE,CAAC,CAAC,OAAO,CAAC,SAAS,CAAC;gBAAC,eAAe,CAAC,OAAO,CAAC,CAAC;YAEhD,EAAE,CAAC,CAAC,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,CAAC;gBAC3B,YAAY,CAAC,CAAC,cAAc,CAAC,UAAU,IAAI,cAAc,CAAC,MAAM,CAAE,EAAE,OAAO,EAAE,MAAM,CAAC,CAAC;YACvF,CAAC;QACH,CAAC;KACQ,CAAC;AACd,CAAC;AAED,eAAe,OAAO,CAAA"},"dts":{"name":"C:\\Code\\Typescript\\rollup-plugin-screeps/src/rollup-plugin-screeps.d.ts","text":"import { Bundle, Plugin, WriteOptions } from 'rollup';\r\nexport interface ScreepsConfig {\r\n    email: string;\r\n    password: string;\r\n    protocol: \"http\" | \"https\";\r\n    hostname: string;\r\n    port: number;\r\n    path: string;\r\n    branch: string | \"auto\";\r\n}\r\nexport interface ScreepsOptions {\r\n    configFile?: string;\r\n    config?: ScreepsConfig;\r\n    dryRun?: boolean;\r\n}\r\nexport interface CodeList {\r\n    [key: string]: string;\r\n}\r\nexport declare function generateSourceMaps(bundle: Bundle): void;\r\nexport declare function writeSourceMaps(options: WriteOptions): void;\r\nexport declare function validateConfig(cfg: Partial<ScreepsConfig>): cfg is ScreepsConfig;\r\nexport declare function loadConfigFile(configFile: string): ScreepsConfig;\r\nexport declare function uploadSource(config: string | ScreepsConfig, options: WriteOptions, bundle: Bundle): void;\r\nexport declare function getFileList(outputFile: string): CodeList;\r\nexport declare function getBranchName(branch: string): string | undefined;\r\nexport declare function screeps(screepsOptions?: ScreepsOptions): Plugin;\r\nexport default screeps;\r\n"}}
